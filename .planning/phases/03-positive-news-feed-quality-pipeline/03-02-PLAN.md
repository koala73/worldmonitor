---
phase: 03-positive-news-feed-quality-pipeline
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/PositiveNewsFeedPanel.ts
  - src/services/rss.ts
  - src/types/index.ts
  - src/styles/happy-theme.css
autonomous: true
requirements: [NEWS-01, NEWS-02]

must_haves:
  truths:
    - "Positive news items display as rich cards with title, source name, publication time, and category badge"
    - "Cards that have images show the image; cards without images render gracefully as text-only cards"
    - "A filter bar with 'All' + 6 category buttons lets users filter displayed stories"
    - "Clicking a category filter shows only stories matching that category"
    - "Clicking 'All' shows all stories again"
    - "Category filter state survives data refresh (does not reset to All on new data)"
    - "RSS image URLs are extracted from media:content, media:thumbnail, enclosure, or img-in-description"
  artifacts:
    - path: "src/components/PositiveNewsFeedPanel.ts"
      provides: "Scrolling positive news feed panel with category filter bar and image cards"
      exports: ["PositiveNewsFeedPanel"]
      min_lines: 100
    - path: "src/types/index.ts"
      provides: "imageUrl optional field on NewsItem interface"
      contains: "imageUrl"
    - path: "src/services/rss.ts"
      provides: "Image URL extraction from RSS XML during feed parsing"
      contains: "extractImageUrl"
    - path: "src/styles/happy-theme.css"
      provides: "Positive card and filter bar CSS styles"
      contains: "positive-card"
  key_links:
    - from: "src/components/PositiveNewsFeedPanel.ts"
      to: "src/services/positive-classifier.ts"
      via: "import HAPPY_CATEGORY_ALL, HAPPY_CATEGORY_LABELS for filter bar"
      pattern: "import.*HAPPY_CATEGORY"
    - from: "src/components/PositiveNewsFeedPanel.ts"
      to: "src/types/index.ts"
      via: "import NewsItem for item rendering"
      pattern: "import.*NewsItem"
    - from: "src/services/rss.ts extractImageUrl()"
      to: "src/types/index.ts imageUrl"
      via: "populates imageUrl field during RSS parsing"
      pattern: "imageUrl.*extractImageUrl"
---

<objective>
Build the PositiveNewsFeedPanel component -- a scrolling news feed that displays curated positive stories as rich cards with images, category badges, and a filter bar. Also extend RSS parsing to extract image URLs from feeds.

Purpose: This is the primary visible panel for the happy variant -- the main content surface users interact with. It replaces the existing generic NewsPanels that the dynamic FEEDS loop creates, offering a unified feed view with category filtering instead of separate per-category panels.

Output: A new PositiveNewsFeedPanel component ready to be wired into App.ts, and RSS image extraction for richer cards.
</objective>

<execution_context>
@/Users/sebastienmelki/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastienmelki/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-positive-news-feed-quality-pipeline/03-RESEARCH.md
@src/components/Panel.ts
@src/components/NewsPanel.ts
@src/services/positive-classifier.ts
@src/types/index.ts
@src/services/rss.ts
@src/styles/happy-theme.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add imageUrl to NewsItem and extract images from RSS</name>
  <files>src/types/index.ts, src/services/rss.ts</files>
  <action>
**Step 1: Extend NewsItem type (src/types/index.ts)**

Add `imageUrl?: string;` to the NewsItem interface, after the `happyCategory` field. Add a comment: `// Image URL extracted from RSS media/enclosure tags`.

**Step 2: Add extractImageUrl function to rss.ts**

Add a private helper function `extractImageUrl(item: Element): string | undefined` before the `fetchFeed` function. The function tries multiple RSS image sources in priority order:

1. `media:content` with namespace `http://search.yahoo.com/mrss/` -- use `getElementsByTagNameNS`. Get the `url` attribute. Only accept if it looks like an image URL (contains 'image' in type attribute, or ends with common image extensions, or has no type attribute -- most RSS feeds omit the type).
2. `media:thumbnail` with same namespace -- get `url` attribute.
3. `<enclosure>` with `type` starting with `image/` -- get `url` attribute.
4. Fallback: parse first `<img src="...">` from `<description>` or `<content:encoded>` text content using regex `/<img[^>]+src=["']([^"']+)["']/`.
5. Return `undefined` if no image found.

**Research confirmed feed image patterns:**
- Good News Network: `<media:content url="..." medium="image">`
- Positive.News: `<media:content url="...">`
- Reasons to be Cheerful: `<enclosure url="..." type="image/jpeg">`
- Optimist Daily: `<img>` in `<description>` CDATA

**Step 3: Wire extractImageUrl into fetchFeed()**

In the `fetchFeed` function, inside the `.map()` callback (~line 204-236), after constructing the return object, add `imageUrl: extractImageUrl(item)` to the returned object. This is a simple addition to the object literal -- no structural change to fetchFeed.

**IMPORTANT:** The `extractImageUrl` function must handle XML namespace issues gracefully. Some feeds may not declare the `media` namespace. Use try/catch around namespace-specific calls and fall through to the next strategy. Never throw -- always return undefined on failure.

**IMPORTANT:** Only extract imageUrl when `SITE_VARIANT === 'happy'` to avoid unnecessary work for other variants. Add the conditional in the map callback: `...(SITE_VARIANT === 'happy' && { imageUrl: extractImageUrl(item) })`.
  </action>
  <verify>
1. `npx tsc --noEmit` passes -- NewsItem has imageUrl field, rss.ts compiles
2. `grep -n "imageUrl" src/types/index.ts` shows the new field
3. `grep -n "extractImageUrl" src/services/rss.ts` shows the function and its usage
  </verify>
  <done>
NewsItem interface has optional imageUrl field. RSS parsing extracts images from media:content, media:thumbnail, enclosure, and img-in-description for happy variant feeds. No change to non-happy variant behavior.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PositiveNewsFeedPanel component with filter bar and card rendering</name>
  <files>src/components/PositiveNewsFeedPanel.ts, src/styles/happy-theme.css</files>
  <action>
**Step 1: Create src/components/PositiveNewsFeedPanel.ts**

Create a new panel component extending `Panel` (from `./Panel`). Follow the existing NewsPanel pattern but simplified for positive news display.

**Constructor:**
```typescript
export class PositiveNewsFeedPanel extends Panel {
  private activeFilter: HappyContentCategory | 'all' = 'all';
  private allItems: NewsItem[] = [];
  private filterButtons: Map<string, HTMLButtonElement> = new Map();

  constructor() {
    super({ id: 'positive-feed', title: 'Good News Feed', showCount: true, trackActivity: true });
    this.createFilterBar();
  }
}
```

Import: `Panel` from `./Panel`, `NewsItem` from `@/types`, `HappyContentCategory`, `HAPPY_CATEGORY_ALL`, `HAPPY_CATEGORY_LABELS` from `@/services/positive-classifier`, `formatTime` from `@/utils`, `escapeHtml`, `sanitizeUrl` from `@/utils/sanitize`.

**createFilterBar() method:**
- Create a `div.positive-feed-filters` element
- Add an "All" button (active by default) and one button per category from `HAPPY_CATEGORY_ALL`
- Each button: `button.positive-filter-btn`, text = category label (from `HAPPY_CATEGORY_LABELS`), data-category attribute
- Store buttons in `this.filterButtons` map for active state management
- Attach click handlers that call `setFilter(category | 'all')`
- Insert the filter bar before `this.content` element using `this.element.insertBefore(filterBar, this.content)`

**setFilter(filter) method:**
- Update `this.activeFilter`
- Update button active states (add/remove `active` class)
- Call `this.applyFilter()`

**renderPositiveNews(items: NewsItem[]) public method:**
- Store items in `this.allItems`
- Update panel count badge via `this.setCount(items.length)`
- Call `this.applyFilter()`

**applyFilter() private method:**
- Filter `this.allItems` by `activeFilter` (if 'all', show all; otherwise filter by `item.happyCategory === activeFilter`)
- Call `this.renderCards(filtered)`

**renderCards(items: NewsItem[]) private method:**
- If items.length === 0: show empty state message ("No stories in this category yet")
- Otherwise: build HTML string by mapping items through `renderCard(item)`
- Set `this.content.innerHTML` = the joined HTML
- NOTE: For now use innerHTML. If items exceed ~30, consider WindowedList in a future optimization. Phase 3 curated feeds produce ~40 items max (8 feeds x 5 items each).

**renderCard(item: NewsItem) private method:**
Returns an HTML string for a single card. Structure:
```html
<a class="positive-card" href="{link}" target="_blank" rel="noopener" data-category="{happyCategory}">
  {imageUrl ? <div class="positive-card-image"><img src="{imageUrl}" alt="" loading="lazy" onerror="this.parentElement.style.display='none'"></div> : ''}
  <div class="positive-card-body">
    <div class="positive-card-meta">
      <span class="positive-card-source">{source}</span>
      {happyCategory ? <span class="positive-card-category cat-{happyCategory}">{categoryLabel}</span> : ''}
    </div>
    <span class="positive-card-title">{title}</span>
    <span class="positive-card-time">{formatTime(pubDate)}</span>
  </div>
</a>
```

Use `escapeHtml()` for all text content and `sanitizeUrl()` for URLs. The card is an `<a>` tag so the entire card is clickable to open the story.

**destroy() override:**
Clean up event listeners from filter buttons. Call `super.destroy()`.

**Step 2: Add CSS styles to src/styles/happy-theme.css**

Add styles at the end of the file, scoped under `[data-variant='happy']`:

**Filter bar styles:**
```css
[data-variant='happy'] .positive-feed-filters {
  display: flex;
  gap: 6px;
  padding: 8px 12px;
  overflow-x: auto;
  scrollbar-width: none;
  border-bottom: 1px solid var(--border-color);
  flex-shrink: 0;
}
[data-variant='happy'] .positive-feed-filters::-webkit-scrollbar { display: none; }

[data-variant='happy'] .positive-filter-btn {
  padding: 4px 10px;
  border-radius: 12px;
  border: 1px solid var(--border-color);
  background: transparent;
  color: var(--text-secondary);
  font-size: 11px;
  white-space: nowrap;
  cursor: pointer;
  transition: background 0.2s, color 0.2s, border-color 0.2s;
  font-family: var(--font-body);
}
[data-variant='happy'] .positive-filter-btn:hover {
  border-color: var(--celebration-gold);
  color: var(--text-primary);
}
[data-variant='happy'] .positive-filter-btn.active {
  background: var(--celebration-gold);
  color: var(--bg-primary);
  border-color: var(--celebration-gold);
}
```

**Card styles:**
```css
[data-variant='happy'] .positive-card {
  display: flex;
  gap: 10px;
  padding: 10px 12px;
  border-bottom: 1px solid var(--border-color);
  text-decoration: none;
  color: inherit;
  transition: background 0.15s;
}
[data-variant='happy'] .positive-card:hover {
  background: var(--bg-secondary);
}
[data-variant='happy'] .positive-card-image {
  flex-shrink: 0;
  width: 72px;
  height: 52px;
  border-radius: 6px;
  overflow: hidden;
}
[data-variant='happy'] .positive-card-image img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
[data-variant='happy'] .positive-card-body {
  flex: 1;
  min-width: 0;
  display: flex;
  flex-direction: column;
  gap: 3px;
}
[data-variant='happy'] .positive-card-meta {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 10px;
}
[data-variant='happy'] .positive-card-source {
  color: var(--text-tertiary);
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}
[data-variant='happy'] .positive-card-category {
  padding: 1px 6px;
  border-radius: 8px;
  font-size: 9px;
  font-weight: 600;
  background: var(--sage-growth);
  color: white;
}
[data-variant='happy'] .positive-card-category.cat-science-health { background: var(--hope-blue); }
[data-variant='happy'] .positive-card-category.cat-nature-wildlife { background: var(--sage-growth); }
[data-variant='happy'] .positive-card-category.cat-humanity-kindness { background: var(--kindness-pink); }
[data-variant='happy'] .positive-card-category.cat-innovation-tech { background: var(--celebration-gold); color: var(--bg-primary); }
[data-variant='happy'] .positive-card-category.cat-climate-wins { background: #2d9a4e; }
[data-variant='happy'] .positive-card-category.cat-culture-community { background: #8b5cf6; }

[data-variant='happy'] .positive-card-title {
  font-size: 13px;
  line-height: 1.35;
  font-weight: 500;
  color: var(--text-primary);
  /* Clamp to 2 lines */
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
[data-variant='happy'] .positive-card-time {
  font-size: 10px;
  color: var(--text-tertiary);
}

/* Empty state */
[data-variant='happy'] .positive-feed-empty {
  padding: 24px 16px;
  text-align: center;
  color: var(--text-tertiary);
  font-size: 13px;
}
```

Ensure the CSS variables referenced (`--celebration-gold`, `--sage-growth`, `--hope-blue`, `--kindness-pink`, `--bg-primary`, `--bg-secondary`, `--text-primary`, `--text-secondary`, `--text-tertiary`, `--border-color`, `--font-body`) are already defined in the happy theme from Phase 1. They should be -- verify by checking the existing happy-theme.css custom properties.
  </action>
  <verify>
1. `npx tsc --noEmit` passes -- PositiveNewsFeedPanel compiles correctly
2. `grep -n "export class PositiveNewsFeedPanel" src/components/PositiveNewsFeedPanel.ts` returns a match
3. `grep -n "renderPositiveNews" src/components/PositiveNewsFeedPanel.ts` returns a match (public API)
4. `grep -n "positive-card" src/styles/happy-theme.css` returns matches for card styles
5. `grep -n "positive-filter-btn" src/styles/happy-theme.css` returns matches for filter styles
  </verify>
  <done>
PositiveNewsFeedPanel component exists with: filter bar (All + 6 categories), rich card rendering (image, title, source, category badge, time), filter state preserved across data updates. CSS styles added to happy-theme.css for cards and filter bar with category-specific badge colors.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `npx tsc --noEmit` -- full project type-checks cleanly
2. PositiveNewsFeedPanel exports a class that can be instantiated and has `renderPositiveNews(items: NewsItem[])` public method
3. NewsItem type includes `imageUrl?: string`
4. RSS parsing extracts imageUrl for happy variant feeds
5. CSS styles use existing happy theme variables (no hardcoded colors outside the category badge palette)
</verification>

<success_criteria>
- PositiveNewsFeedPanel component renders positive news items as rich cards with title, source, image (when available), category badge, and time
- Filter bar with 'All' + 6 category buttons enables client-side filtering by happyCategory
- Active filter survives data updates (renderPositiveNews called again doesn't reset filter to 'All')
- RSS image extraction handles all 4 curated feed image patterns (media:content, media:thumbnail, enclosure, img-in-description)
- Cards without images render cleanly as text-only cards
- All CSS scoped under [data-variant='happy'] to avoid affecting other variants
</success_criteria>

<output>
After completion, create `.planning/phases/03-positive-news-feed-quality-pipeline/03-02-SUMMARY.md`
</output>
