---
phase: 03-positive-news-feed-quality-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/App.ts
  - src/components/LiveNewsPanel.ts
autonomous: true
requirements: [NEWS-03]

must_haves:
  truths:
    - "Happy variant does NOT show DEFCON/PizzInt indicator"
    - "Happy variant does NOT load military, intelligence, financial, or geopolitical data"
    - "Happy variant does NOT show Bloomberg/war live news channels"
    - "Happy variant shows a sun icon link in the variant switcher header"
    - "Happy variant does NOT schedule irrelevant refresh intervals (intelligence, FIRMS, oil, spending, etc.)"
    - "Happy variant search modal registers no geopolitical/military sources"
    - "Map section title shows 'Good News Map' for happy variant"
    - "Default/tech/finance variants are completely unaffected"
  artifacts:
    - path: "src/App.ts"
      provides: "Happy variant conditional guards across all code paths"
      contains: "SITE_VARIANT === 'happy'"
    - path: "src/components/LiveNewsPanel.ts"
      provides: "Happy variant excluded from LiveNewsPanel (empty channels or skip)"
      contains: "happy"
  key_links:
    - from: "src/App.ts setupPizzIntIndicator()"
      to: "SITE_VARIANT check"
      via: "early return for happy"
      pattern: "SITE_VARIANT === 'happy'"
    - from: "src/App.ts renderLayout()"
      to: "variant switcher HTML"
      via: "happy variant link with sun icon"
      pattern: "happy\\.worldmonitor\\.app"
    - from: "src/App.ts loadAllData()"
      to: "happy variant task filtering"
      via: "conditional task exclusion"
      pattern: "SITE_VARIANT !== 'happy'"
    - from: "src/App.ts setupRefreshIntervals()"
      to: "happy variant refresh filtering"
      via: "conditional schedule exclusion"
      pattern: "SITE_VARIANT !== 'happy'"
---

<objective>
Wire the happy variant as a first-class citizen in App.ts so it no longer falls through to default WorldMonitor behavior. This fixes the Phase 2 UAT blocker where happy shows DEFCON, Bloomberg, military data, and geopolitical panels.

Purpose: Without this, the happy variant is visually and functionally indistinguishable from the full variant. This is the prerequisite for all other Phase 3 work -- no point building a news feed panel if the dashboard still shows war coverage.

Output: A happy variant that shows only its own panels (map + dynamic FEEDS-based news panels), loads only news data, and has a clean positive-only experience.
</objective>

<execution_context>
@/Users/sebastienmelki/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastienmelki/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-positive-news-feed-quality-pipeline/03-RESEARCH.md
@.planning/phases/02-curated-content-pipeline/02-UAT.md
@.planning/debug/happy-variant-not-loading.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add happy variant guards to all App.ts code paths</name>
  <files>src/App.ts</files>
  <action>
Systematically add happy variant handling to every identified gap in App.ts. Reference the gap inventory from the debug session (.planning/debug/happy-variant-not-loading.md) and research (03-RESEARCH.md App.ts Integration Gap Inventory table).

**1. setupPizzIntIndicator() (~line 696):**
Add `|| SITE_VARIANT === 'happy'` to the early return condition so DEFCON indicator is hidden for happy variant.

**2. Variant switcher in renderLayout() (~lines 1835-1862):**
After the finance variant link and before the closing `</div>`, add a happy variant link:
- URL: `https://happy.worldmonitor.app`
- Icon: sun emoji or similar warm icon (use the existing pattern from tech/finance links)
- Label: "Good News" (matches VARIANT_CONFIG.description)
- Active state when `SITE_VARIANT === 'happy'`
- Same `target="_blank"` and desktop app logic as other variants

**3. Map section title (~line 1905):**
Extend the ternary to include happy variant: show a positive map title (e.g., use i18n key `panels.happyMap` if it exists, otherwise hardcode 'Good News Map' for now). Pattern: `SITE_VARIANT === 'tech' ? t('panels.techMap') : SITE_VARIANT === 'happy' ? 'Good News Map' : t('panels.map')`

**4. createPanels() -- skip geopolitical panels for happy (~line 2290):**
The `if (SITE_VARIANT === 'full')` block (lines 2290-2339) already gates geopolitical panels. Good -- happy won't get those. But LiveNewsPanel (line 2349) and other panels below are created unconditionally. For happy variant, skip creation of: LiveNewsPanel (line 2349), LiveWebcamsPanel (line 2352), TechEventsPanel (line 2356), ServiceStatusPanel (line 2359), TechReadinessPanel (line 2368), MacroSignalsPanel (line 2372), ETFFlowsPanel (line 2373), StablecoinPanel (line 2374). Gate these with `if (SITE_VARIANT !== 'happy')` checks. The InsightsPanel (line 2377) can stay for all variants since it adapts to available data.

Also gate the live-news first-position logic (lines 2401-2407) with `SITE_VARIANT !== 'happy'` since there's no live-news panel for happy.

**5. loadAllData() (~lines 3118-3126):**
For happy variant, only load 'news'. Skip markets, predictions, pizzint, fred, oil, spending. Wrap the non-news tasks in a `SITE_VARIANT !== 'happy'` check. Keep the 'news' task always present since happy variant uses it for positive feeds.

Also skip the conditional layer loads (intelligence, firms, natural, weather, ais, cables, flights, cyberThreats, techEvents, techReadiness) for happy variant -- except natural (already in happy map layers). Gate each non-news, non-natural task appropriately.

**6. setupRefreshIntervals() (~lines 4601-4635):**
For happy variant, only schedule 'news' refresh. Skip: markets, predictions, pizzint, natural, weather, fred, oil, spending, intelligence, firms, ais, cables, cableHealth, flights, cyberThreats. Wrap non-news schedules in `if (SITE_VARIANT !== 'happy')` or more specific variant checks that preserve existing behavior for full/tech/finance.

**7. setupSearchModal() (~lines 1304-1430):**
Add a `SITE_VARIANT === 'happy'` branch. For happy variant, use a positive-themed placeholder (e.g., "Search good news...") and register NO sources (or minimal positive sources -- empty is fine for now since there are no geopolitical/military assets to search). The existing else block (line 1373) falls through to geopolitical sources for happy -- prevent this by adding the happy check before the else.

**8. DESKTOP_BUILD_VARIANT (~line 127):**
This can stay as-is. The desktop app doesn't serve happy variant (it's web-only via happy.worldmonitor.app hostname detection). Happy falling through to 'full' for desktop is correct.

**CRITICAL:** Do NOT change any behavior for full, tech, or finance variants. Every modification must be additive for happy only. Test by grepping for `SITE_VARIANT` after changes to confirm all paths handle 'happy'.
  </action>
  <verify>
1. `npx tsc --noEmit` passes with no type errors
2. `grep -n "SITE_VARIANT" src/App.ts | grep -c "happy"` returns 7+ matches (one per gap fixed)
3. `grep -n "setupPizzIntIndicator" src/App.ts` shows happy in the exclusion line
4. `grep -n "happy.worldmonitor" src/App.ts` returns at least 1 match (variant switcher)
5. `grep -n "Good News Map" src/App.ts` returns at least 1 match (map title)
  </verify>
  <done>
All 7 App.ts code paths handle happy variant explicitly. DEFCON hidden, variant switcher has happy link, map shows positive title, no geopolitical panels created, only news data loaded, only news refresh scheduled, search modal has no military sources. Full/tech/finance variants unchanged.
  </done>
</task>

<task type="auto">
  <name>Task 2: Exclude happy variant from LiveNewsPanel Bloomberg channels</name>
  <files>src/components/LiveNewsPanel.ts</files>
  <action>
The LiveNewsPanel.ts selects channels on line 74: `const LIVE_CHANNELS = SITE_VARIANT === 'tech' ? TECH_LIVE_CHANNELS : FULL_LIVE_CHANNELS;`

Since Task 1 already prevents LiveNewsPanel creation for happy variant in createPanels(), this is a defense-in-depth change. But the module-level `LIVE_CHANNELS` constant evaluates at import time regardless.

Two options:
- Option A (simpler): In createPanels() Task 1, we already skip LiveNewsPanel for happy. The LIVE_CHANNELS constant at module level is harmless since it's never used. No change needed to LiveNewsPanel.ts.
- Option B (belt-and-suspenders): Add `SITE_VARIANT === 'happy' ? [] : ` to the LIVE_CHANNELS ternary.

Go with Option A -- the skippage in createPanels() is sufficient. **If** for some reason LiveNewsPanel is still instantiated (e.g., saved panel order restoration), add a guard in LiveNewsPanel constructor to early-return or show empty state when `SITE_VARIANT === 'happy'`.

Actually, check if `panelOrder` in createPanels() (line 2382) could restore 'live-news' from savedOrder even if we skip creating it. The answer is yes -- `defaultOrder` comes from `Object.keys(DEFAULT_PANELS)` which is variant-aware (HAPPY_PANELS doesn't include 'live-news'), and `valid = savedOrder.filter(k => defaultOrder.includes(k))` filters out panels not in defaultOrder. So saved order won't resurrect it.

Therefore, the minimal change is: update the LIVE_CHANNELS constant to return an empty array for happy, as a safety net:

```typescript
const LIVE_CHANNELS = SITE_VARIANT === 'tech' ? TECH_LIVE_CHANNELS : SITE_VARIANT === 'happy' ? [] as LiveChannel[] : FULL_LIVE_CHANNELS;
```

This ensures even if LiveNewsPanel is somehow instantiated, it has no channels to play.
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. `grep -n "happy" src/components/LiveNewsPanel.ts` returns at least 1 match
  </verify>
  <done>
LiveNewsPanel returns empty channels for happy variant. Combined with Task 1's createPanels() guard, there is zero chance of Bloomberg/war streams appearing on happy variant.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. Run `VITE_VARIANT=happy npx vite build` -- build succeeds with no errors
2. Run `npx tsc --noEmit` -- type check passes
3. Grep audit: `grep -rn "SITE_VARIANT" src/App.ts` shows happy handling at all critical locations
4. Grep audit: `grep -rn "SITE_VARIANT" src/components/LiveNewsPanel.ts` shows happy handling
5. Confirm no changes to full/tech/finance behavior by verifying no existing conditionals were modified (only new branches added)
</verification>

<success_criteria>
- Happy variant in App.ts is a first-class citizen with explicit handling at all 7+ code paths
- DEFCON indicator hidden for happy
- Variant switcher shows happy option with warm icon
- Map title shows positive variant name
- No geopolitical/military/financial panels created for happy
- No irrelevant data loaded or refreshed for happy
- LiveNewsPanel has empty channels for happy (defense in depth)
- Full, tech, and finance variants are completely unaffected
</success_criteria>

<output>
After completion, create `.planning/phases/03-positive-news-feed-quality-pipeline/03-01-SUMMARY.md`
</output>
