---
phase: 08-map-data-overlays
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/components/DeckGLMap.ts
  - src/components/MapContainer.ts
  - src/App.ts
  - src/styles/happy-theme.css
autonomous: true
requirements: [MAP-03, MAP-04, MAP-05]

must_haves:
  truths:
    - "Countries on the map are colored by happiness score in a green gradient (happier = deeper green)"
    - "Species recovery zones appear as green circle markers at each species' habitat location"
    - "Renewable energy installations appear as color-coded markers (solar=gold, wind=blue, hydro=teal, geothermal=orange)"
    - "Users can toggle each of the three new layers on/off via the layer toggle panel"
    - "Hovering a choropleth country shows country name and happiness score in a tooltip"
    - "Hovering species/energy markers shows name and details in a tooltip"
  artifacts:
    - path: "src/components/DeckGLMap.ts"
      provides: "Three new Deck.gl layer creation methods and layer toggle/legend entries"
      contains: "createHappinessChoroplethLayer"
    - path: "src/components/MapContainer.ts"
      provides: "Delegation methods for happiness, species recovery, and renewable installation data"
      contains: "setHappinessScores"
    - path: "src/App.ts"
      provides: "Data loading and map integration for all three overlay layers"
      contains: "fetchHappinessScores"
  key_links:
    - from: "src/App.ts"
      to: "src/services/happiness-data.ts"
      via: "import and call in refreshAll"
      pattern: "fetchHappinessScores"
    - from: "src/App.ts"
      to: "src/components/MapContainer.ts"
      via: "setHappinessScores delegation"
      pattern: "map\\.setHappinessScores"
    - from: "src/components/MapContainer.ts"
      to: "src/components/DeckGLMap.ts"
      via: "DeckGL-only delegation"
      pattern: "deckGLMap\\?.setHappinessScores"
    - from: "src/components/DeckGLMap.ts"
      to: "src/services/country-geometry.ts"
      via: "GeoJSON reuse for choropleth"
      pattern: "getCountriesGeoJson"
---

<objective>
Create three Deck.gl map overlay layers (happiness choropleth, species recovery zones, renewable installations), wire layer toggles and legend entries, add MapContainer delegation, and integrate data loading in App.ts.

Purpose: Make world happiness, species recovery zones, and renewable energy installations visible as interactive map overlays on the happy variant.
Output: Three new toggleable map layers with tooltips, fully wired from data loading through to rendering.
</objective>

<execution_context>
@/Users/sebastienmelki/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastienmelki/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-map-data-overlays/08-RESEARCH.md
@.planning/phases/08-map-data-overlays/08-01-SUMMARY.md
@src/components/DeckGLMap.ts
@src/components/MapContainer.ts
@src/App.ts
@src/services/country-geometry.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add three Deck.gl overlay layers, layer toggles, legend entries, and tooltips in DeckGLMap.ts</name>
  <files>
    src/components/DeckGLMap.ts
  </files>
  <action>
**Imports:** Add imports for the three new service types at top of file:
```typescript
import type { HappinessData } from '@/services/happiness-data';
import type { RenewableInstallation } from '@/services/renewable-installations';
import type { SpeciesRecovery } from '@/services/conservation-data';
```

**Instance fields:** Add private fields for the three data sources:
```typescript
private happinessScores: Map<string, number> = new Map();
private happinessYear = 0;
private happinessSource = '';
private speciesRecoveryZones: Array<SpeciesRecovery & { recoveryZone: { name: string; lat: number; lon: number } }> = [];
private renewableInstallations: RenewableInstallation[] = [];
private countriesGeoJsonData: FeatureCollection<Geometry> | null = null;
```

**Data setters (public):** Follow the exact `setPositiveEvents`/`setKindnessData` pattern:
```typescript
public setHappinessScores(data: HappinessData): void {
  this.happinessScores = data.scores;
  this.happinessYear = data.year;
  this.happinessSource = data.source;
  this.render();
}

public setSpeciesRecoveryZones(species: SpeciesRecovery[]): void {
  this.speciesRecoveryZones = species.filter(
    (s): s is SpeciesRecovery & { recoveryZone: { name: string; lat: number; lon: number } } =>
      s.recoveryZone != null
  );
  this.render();
}

public setRenewableInstallations(installations: RenewableInstallation[]): void {
  this.renewableInstallations = installations;
  this.render();
}
```

**GeoJSON caching for choropleth:** In the existing `loadCountryBoundaries()` method, after `getCountriesGeoJson()` resolves, cache the reference:
```typescript
this.countriesGeoJsonData = geojson;
```
This avoids loading GeoJSON twice. The choropleth layer will use this cached reference.

**Layer creation methods:**

1. `createHappinessChoroplethLayer(): GeoJsonLayer | null` -- Returns null if `this.countriesGeoJsonData` is null or `this.happinessScores.size === 0`. Otherwise creates a `GeoJsonLayer`:
   - `id: 'happiness-choropleth-layer'`
   - `data: this.countriesGeoJsonData`
   - `filled: true`, `stroked: true`
   - `getFillColor` accessor: reads `feature.properties['ISO3166-1-Alpha-2']`, looks up score in `this.happinessScores`. No data = `[0, 0, 0, 0]` (transparent). Score present: normalize `t = score / 10`, then green gradient:
     - R: `Math.round(40 + (1 - t) * 180)` (40=happy green, 220=unhappy pale)
     - G: `Math.round(180 + t * 60)` (180 base to 240 happy)
     - B: `Math.round(40 + (1 - t) * 100)` (40=happy to 140=unhappy)
     - Alpha: 140 (semi-transparent to not fully obscure basemap)
   - `getLineColor: [100, 100, 100, 60]`, `getLineWidth: 1`, `lineWidthMinPixels: 0.5`
   - `pickable: true`
   - `updateTriggers: { getFillColor: [this.happinessScores.size] }`

2. `createSpeciesRecoveryLayer(): ScatterplotLayer` -- Creates a `ScatterplotLayer` with:
   - `id: 'species-recovery-layer'`
   - `data: this.speciesRecoveryZones`
   - `getPosition: (d) => [d.recoveryZone.lon, d.recoveryZone.lat]`
   - `getRadius: 50000` (~50km), `radiusMinPixels: 8`, `radiusMaxPixels: 25`
   - `getFillColor: [74, 222, 128, 120]` (nature green with transparency)
   - `stroked: true`, `getLineColor: [74, 222, 128, 200]`, `lineWidthMinPixels: 1.5`
   - `pickable: true`

3. `createRenewableInstallationsLayer(): ScatterplotLayer` -- Creates a `ScatterplotLayer` with:
   - `id: 'renewable-installations-layer'`
   - `data: this.renewableInstallations`
   - `getPosition: (d) => [d.lon, d.lat]`
   - `getRadius: 30000` (~30km), `radiusMinPixels: 5`, `radiusMaxPixels: 18`
   - `getFillColor` accessor based on `d.type`:
     - solar: `[255, 200, 50, 200]` (gold)
     - wind: `[100, 200, 255, 200]` (sky blue)
     - hydro: `[0, 180, 180, 200]` (teal)
     - geothermal: `[255, 150, 80, 200]` (warm orange)
   - `stroked: true`, `getLineColor` same as fill but alpha 255, `lineWidthMinPixels: 1`
   - `pickable: true`

**Wire layers into `buildLayers()`:** In the `buildLayers()` method, add the three new layers gated by their MapLayers keys. The happiness choropleth should be pushed FIRST among the new layers (it renders below point markers):
```typescript
if (mapLayers.happiness) {
  const choropleth = this.createHappinessChoroplethLayer();
  if (choropleth) layers.push(choropleth);
}
if (mapLayers.speciesRecovery && this.speciesRecoveryZones.length > 0) {
  layers.push(this.createSpeciesRecoveryLayer());
}
if (mapLayers.renewableInstallations && this.renewableInstallations.length > 0) {
  layers.push(this.createRenewableInstallationsLayer());
}
```
Place these AFTER the existing positive events and kindness layers in the method, so point markers render on top of the choropleth.

**Tooltips:** In the `getTooltip()` method (or the tooltip handler), add cases for the three new layer IDs:
```typescript
case 'happiness-choropleth-layer': {
  const name = obj.properties?.name ?? 'Unknown';
  const code = obj.properties?.['ISO3166-1-Alpha-2'];
  const score = code ? this.happinessScores.get(code) : undefined;
  const scoreStr = score != null ? score.toFixed(1) : 'No data';
  return { html: `<div class="deckgl-tooltip"><strong>${text(name)}</strong><br/>Happiness: ${scoreStr}/10${score != null ? `<br/><span style="opacity:.7">${this.happinessSource} (${this.happinessYear})</span>` : ''}</div>` };
}
case 'species-recovery-layer': {
  return { html: `<div class="deckgl-tooltip"><strong>${text(obj.commonName)}</strong><br/>${text(obj.recoveryZone?.name ?? obj.region)}<br/><span style="opacity:.7">Status: ${obj.recoveryStatus}</span></div>` };
}
case 'renewable-installations-layer': {
  const typeLabel = obj.type ? obj.type.charAt(0).toUpperCase() + obj.type.slice(1) : 'Renewable';
  return { html: `<div class="deckgl-tooltip"><strong>${text(obj.name)}</strong><br/>${typeLabel} &middot; ${obj.capacityMW?.toLocaleString() ?? '?'} MW<br/><span style="opacity:.7">${obj.country} &middot; ${obj.year}</span></div>` };
}
```

**Layer toggles:** In the `createLayerToggles()` method, extend the `SITE_VARIANT === 'happy'` array with three new toggle entries:
```typescript
{ key: 'happiness', label: 'World Happiness', icon: '&#128522;' },
{ key: 'speciesRecovery', label: 'Species Recovery', icon: '&#128062;' },
{ key: 'renewableInstallations', label: 'Clean Energy', icon: '&#9889;' },
```
Add these AFTER the existing 3 happy toggles (Positive Events, Acts of Kindness, Natural Events).

**Legend:** In the `createLegend()` method, extend the `SITE_VARIANT === 'happy'` array with entries for the new layers:
```typescript
{ shape: shapes.rect('rgb(34, 180, 100)'), label: 'Happy Country' },
{ shape: shapes.circle('rgb(74, 222, 128)'), label: 'Species Recovery Zone' },
{ shape: shapes.circle('rgb(255, 200, 50)'), label: 'Renewable Installation' },
```
Use `shapes.rect` for the choropleth legend item (rectangles for area layers). Add after existing happy legend items.
  </action>
  <verify>
```bash
npx tsc --noEmit
```
Must pass. Verify the three new layer methods, data setters, toggle entries, and legend items exist.
  </verify>
  <done>
DeckGLMap has three new layer creation methods, three data setters, six new toggle entries, three new legend items, and three new tooltip cases. All layers are gated by their MapLayers keys and render with the correct color schemes. TypeScript compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add MapContainer delegation, App.ts data loading, and tooltip CSS</name>
  <files>
    src/components/MapContainer.ts
    src/App.ts
    src/styles/happy-theme.css
  </files>
  <action>
**1. MapContainer delegation (`src/components/MapContainer.ts`):**

Add three new delegation methods following the exact `setPositiveEvents`/`setKindnessData` pattern:

```typescript
public setHappinessScores(data: HappinessData): void {
  if (this.useDeckGL) {
    this.deckGLMap?.setHappinessScores(data);
  }
  // SVG map does not support choropleth overlay
}

public setSpeciesRecoveryZones(species: SpeciesRecovery[]): void {
  if (this.useDeckGL) {
    this.deckGLMap?.setSpeciesRecoveryZones(species);
  }
  // SVG map does not support species recovery layer
}

public setRenewableInstallations(installations: RenewableInstallation[]): void {
  if (this.useDeckGL) {
    this.deckGLMap?.setRenewableInstallations(installations);
  }
  // SVG map does not support renewable installations layer
}
```

Add the necessary type imports at the top:
```typescript
import type { HappinessData } from '@/services/happiness-data';
import type { SpeciesRecovery } from '@/services/conservation-data';
import type { RenewableInstallation } from '@/services/renewable-installations';
```

**2. App.ts data loading (`src/App.ts`):**

Add imports at the top:
```typescript
import { fetchHappinessScores } from '@/services/happiness-data';
import { fetchRenewableInstallations } from '@/services/renewable-installations';
```
(Note: `fetchConservationWins` is already imported from Phase 7 wiring.)

In `refreshAll()`, inside the existing `SITE_VARIANT === 'happy'` block (where species and renewable panel data is already loaded), add three new data loading tasks:

```typescript
// Map overlay data (Phase 8)
fetchHappinessScores().then(data => {
  this.map?.setHappinessScores(data);
}).catch(() => { /* graceful degradation */ }),

fetchConservationWins().then(species => {
  this.map?.setSpeciesRecoveryZones(species);
}).catch(() => { /* graceful degradation */ }),

fetchRenewableInstallations().then(installations => {
  this.map?.setRenewableInstallations(installations);
}).catch(() => { /* graceful degradation */ }),
```

These are fire-and-forget async tasks alongside the existing data loading. The `fetchConservationWins()` call may already exist for the SpeciesComebackPanel -- if so, chain from the same promise or make a second call (it's a dynamic import that gets cached). Do NOT duplicate the import if it's already there.

Check if `fetchConservationWins` is already called in `refreshAll()`. If yes, chain the `setSpeciesRecoveryZones` call from the same promise. Example:
```typescript
const speciesPromise = fetchConservationWins();
speciesPromise.then(species => {
  this.speciesComebackPanel?.setSpecies(species);
  this.map?.setSpeciesRecoveryZones(species); // Phase 8 overlay
}).catch(() => {});
```

**3. CSS for tooltip polish (`src/styles/happy-theme.css`):**

No new CSS is strictly needed (tooltips use the existing `.deckgl-tooltip` styles). However, add a subtle style for the choropleth legend rectangle if `shapes.rect` doesn't exist in the current legend system. In that case, use `shapes.circle` with a different color instead and skip custom CSS.

Review the legend `shapes` object in DeckGLMap.ts. If it only has `circle`, use `shapes.circle('rgb(34, 180, 100)')` for the choropleth legend item instead of `shapes.rect`.
  </action>
  <verify>
```bash
npx tsc --noEmit
```
Must pass with zero errors. Verify:
1. MapContainer has three new public delegation methods
2. App.ts calls all three data fetchers in the happy variant block
3. No duplicate imports or calls
  </verify>
  <done>
MapContainer delegates happiness, species recovery, and renewable installation data to DeckGLMap. App.ts loads all three datasets at startup and passes them to the map. All three overlay layers render on the happy variant map with tooltips and toggle controls. TypeScript compiles cleanly.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. On happy variant, the World Happiness choropleth layer colors countries green by happiness score
3. Layer toggle panel shows six toggles (3 existing + 3 new) for happy variant
4. Species recovery zones appear as green circles at the 10 known habitat locations
5. Renewable installations appear as color-coded dots (gold/blue/teal/orange) across the globe
6. Tooltips show relevant data for all three new layer types when hovering
7. Toggling each layer on/off hides/shows the corresponding markers
</verification>

<success_criteria>
- Happiness choropleth renders countries in green gradient (deeper green = happier)
- 10 species recovery zone markers visible at correct geographic locations
- 80+ renewable installation markers visible with type-based color coding
- All three layers are toggleable via the happy variant layer toggle panel
- Tooltips display happiness score, species name/status, or installation name/capacity
- No regressions in existing happy variant layers (positive events, kindness, natural)
- TypeScript compilation passes with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-map-data-overlays/08-02-SUMMARY.md`
</output>
