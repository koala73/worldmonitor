---
phase: 03-legacy-edge-function-migration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - proto/worldmonitor/news/v1/summarize_article.proto
  - proto/worldmonitor/news/v1/service.proto
  - api/server/worldmonitor/news/v1/handler.ts
  - src/services/summarization.ts
  - api/groq-summarize.js
  - api/ollama-summarize.js
  - api/openrouter-summarize.js
  - api/_summarize-handler.js
  - src/generated/client/worldmonitor/news/v1/service_client.ts
  - src/generated/server/worldmonitor/news/v1/service_server.ts
  - docs/api/NewsService.openapi.yaml
  - docs/api/NewsService.openapi.json
autonomous: true
requirements:
  - CLEAN-02
  - DOMAIN-09
  - DOMAIN-10

must_haves:
  truths:
    - "Summarization works via NewsService.SummarizeArticle RPC with provider parameter instead of /api/{provider}-summarize"
    - "Client fallback chain (ollama -> groq -> openrouter) preserved identically — calls same RPC 3 times with different provider values"
    - "Redis cache behavior preserved — same cache key strategy, 24h TTL"
    - "All 4 legacy summarization files deleted"
    - "Proto messages match the existing JSON response shape"
  artifacts:
    - path: "proto/worldmonitor/news/v1/summarize_article.proto"
      provides: "SummarizeArticleRequest/Response proto messages with provider field"
      contains: "SummarizeArticleRequest"
    - path: "api/server/worldmonitor/news/v1/handler.ts"
      provides: "summarizeArticle RPC handler with provider dispatch"
      contains: "summarizeArticle"
    - path: "src/services/summarization.ts"
      provides: "Client rewired to NewsServiceClient"
      contains: "NewsServiceClient"
  key_links:
    - from: "src/services/summarization.ts"
      to: "api/server/worldmonitor/news/v1/handler.ts"
      via: "NewsServiceClient.summarizeArticle({ provider: 'groq' })"
      pattern: "client\\.summarizeArticle"
    - from: "api/server/worldmonitor/news/v1/handler.ts"
      to: "Upstash Redis"
      via: "Inline getCachedJson/setCachedJson helpers"
      pattern: "getCachedJson|setCachedJson"
---

<objective>
Migrate the 3 LLM summarization endpoints (Groq, Ollama, OpenRouter) and their shared handler into a single SummarizeArticle RPC in the news domain (step 5).

Purpose: Consolidate 4 legacy files (3 provider-specific endpoints + 1 shared handler factory) into a single RPC with provider parameter, preserving identical fallback chain behavior.
Output: Working SummarizeArticle RPC, 4 legacy files deleted, client using NewsServiceClient.
</objective>

<execution_context>
@/Users/sebastienmelki/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastienmelki/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-legacy-edge-function-migration/03-RESEARCH.md
@api/_summarize-handler.js
@api/groq-summarize.js
@api/ollama-summarize.js
@api/openrouter-summarize.js
@src/services/summarization.ts
@api/server/worldmonitor/news/v1/handler.ts
@proto/worldmonitor/news/v1/service.proto
@proto/worldmonitor/news/v1/summarize_headlines.proto
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SummarizeArticle proto + implement handler</name>
  <files>
    proto/worldmonitor/news/v1/summarize_article.proto
    proto/worldmonitor/news/v1/service.proto
    api/server/worldmonitor/news/v1/handler.ts
  </files>
  <action>
**Design decision (Claude's discretion):** Single `SummarizeArticle` RPC with `provider` field, per research recommendation.

1. Create `proto/worldmonitor/news/v1/summarize_article.proto`:
   ```protobuf
   syntax = "proto3";
   package worldmonitor.news.v1;

   message SummarizeArticleRequest {
     string provider = 1;          // "ollama", "groq", "openrouter"
     repeated string headlines = 2;
     string mode = 3;              // "brief", "analysis", "translate", "" (default)
     string geo_context = 4;
     string variant = 5;           // "full", "tech", or target language for translate mode
     string lang = 6;              // output language code, default "en"
   }

   message SummarizeArticleResponse {
     string summary = 1;
     string model = 2;
     string provider = 3;
     bool cached = 4;
     int32 tokens = 5;
     bool fallback = 6;
     bool skipped = 7;
     string reason = 8;
     string error = 9;
     string error_type = 10;
   }
   ```

2. Add RPC to `proto/worldmonitor/news/v1/service.proto`:
   - Import `summarize_article.proto`
   - Add: `rpc SummarizeArticle(SummarizeArticleRequest) returns (SummarizeArticleResponse) { option (sebuf.http.config) = {path: "/summarize-article"}; }`
   - Keep existing SummarizeHeadlines RPC as-is (don't break generated code)

3. Run `cd proto && buf generate`

4. Implement `summarizeArticle` handler in `api/server/worldmonitor/news/v1/handler.ts`:

   Port ALL logic from `_summarize-handler.js` into the handler. This is a substantial port:

   a. **Inline Upstash Redis helpers** — Copy the `getCachedJson`/`setCachedJson` pattern from military handler. Add `hashString` function (port from `_upstash-cache.js`):
      ```typescript
      function hashString(input: string): string {
        let hash = 5381;
        for (let i = 0; i < input.length; i++) {
          hash = ((hash << 5) + hash) + input.charCodeAt(i);
        }
        return (hash >>> 0).toString(36);
      }
      ```

   b. **getCacheKey function** — Port exactly from `_summarize-handler.js`:
      - Cache version: 'v3'
      - Key format: `summary:v3:${mode}:${variant}:${lang}:${hash}${geoHash}`
      - Special case for translate mode: `summary:v3:translate:${targetLang}:${hash}${geoHash}`

   c. **deduplicateHeadlines function** — Port exactly: normalize, split to word sets, check 0.6 similarity threshold

   d. **buildPrompts function** — Port exactly all 4 modes (brief, analysis, translate, default) with tech variant handling. Includes date context with Trump mention for non-tech variants. No changes to prompt text.

   e. **Provider credential resolution** — Based on `provider` field in request:
      - `"ollama"`: OLLAMA_API_URL env var, OLLAMA_MODEL (default llama3.1:8b), optional OLLAMA_API_KEY, extraBody: {think: false}
      - `"groq"`: GROQ_API_KEY env var, apiUrl: 'https://api.groq.com/openai/v1/chat/completions', model: 'llama-3.1-8b-instant'
      - `"openrouter"`: OPENROUTER_API_KEY env var, apiUrl: 'https://openrouter.ai/api/v1/chat/completions', model: 'openrouter/free', extra headers: HTTP-Referer, X-Title
      - If credentials missing: return `{ skipped: true, fallback: true, reason: '...' }`

   f. **Request validation** — headlines must be non-empty array

   g. **Cache check** — Use getCacheKey, check Redis via getCachedJson, return cached response if found

   h. **LLM call** — POST to provider apiUrl with model, messages (system+user from buildPrompts), temperature: 0.3, max_tokens: 150, top_p: 0.9, plus any extraBody

   i. **Response processing** — Extract content from choices[0].message.content or .reasoning. Strip `<think>...</think>` blocks (exact same regex). Handle unterminated think blocks.

   j. **Cache write** — setCachedJson with 86400s TTL (24h)

   k. **Error handling** — On 429: return `{ error: 'Rate limited', fallback: true }`. On other errors: return `{ error, fallback: true }`. On exception: return `{ error, errorType, fallback: true }`.

   **CRITICAL:** No behavior changes. Every prompt, every cache key, every error response must be identical to the legacy handler.
  </action>
  <verify>
`cd proto && buf lint` passes. `npx tsc --noEmit` passes (handler compiles with new types). New proto file exists with SummarizeArticleRequest/Response. Handler has summarizeArticle method.
  </verify>
  <done>SummarizeArticle proto defined and handler implemented with full provider dispatch, caching, prompt building, and think-token stripping.</done>
</task>

<task type="auto">
  <name>Task 2: Rewire summarization client + delete 4 legacy files</name>
  <files>
    src/services/summarization.ts
    api/groq-summarize.js
    api/ollama-summarize.js
    api/openrouter-summarize.js
    api/_summarize-handler.js
  </files>
  <action>
1. Read `src/services/summarization.ts` to understand the current fetch pattern for `/api/{provider}-summarize`

2. Rewire to use NewsServiceClient:
   - Import `NewsServiceClient` from `@/generated/client/worldmonitor/news/v1/service_client`
   - Create client: `new NewsServiceClient('', { fetch: fetch.bind(globalThis) })`
   - Replace each `fetch('/api/ollama-summarize', { method: 'POST', body })` call with `client.summarizeArticle({ provider: 'ollama', headlines, mode, geoContext, variant, lang })`
   - Same for groq and openrouter providers
   - The client-side fallback chain (try ollama -> groq -> openrouter -> browser T5) must remain IDENTICAL. The chain calls the same RPC 3 times with different provider values. Browser T5 stays client-only as final fallback.
   - Map the proto response fields to match the existing interface used by consumers
   - Handle error responses: if response has `fallback: true`, continue the chain to next provider
   - If response has `skipped: true`, continue to next provider (credential missing)
   - **No behavior changes to Ollama base URL handling** — the provider field just tells the handler which provider to use

3. Delete the 4 legacy files:
   - `api/groq-summarize.js`
   - `api/ollama-summarize.js`
   - `api/openrouter-summarize.js`
   - `api/_summarize-handler.js`

4. Also delete `api/_summarize-handler.test.mjs` if it exists

5. Run `npx tsc --noEmit`

6. Commit: `feat(03-02): migrate summarization to news SummarizeArticle RPC`
  </action>
  <verify>
`npx tsc --noEmit` passes. All 4 legacy files deleted. `grep -r 'summarize' src/services/summarization.ts` shows NewsServiceClient usage, no fetch('/api/...-summarize'). `grep -r '_summarize-handler' api/` returns nothing.
  </verify>
  <done>Summarization uses NewsService.SummarizeArticle RPC. Client fallback chain preserved. 4 legacy files deleted. _summarize-handler.js no longer imported (removes one of two _upstash-cache.js importers).</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — full TypeScript compilation passes
2. All 4 legacy summarization files deleted
3. `src/services/summarization.ts` uses `NewsServiceClient.summarizeArticle()` with provider field
4. Handler implements full pipeline: credential check, cache, prompt build, LLM call, think-token strip, cache write
5. No references to `/api/groq-summarize`, `/api/ollama-summarize`, `/api/openrouter-summarize` in `src/`
</verification>

<success_criteria>
- Step 5 complete — all summarization consolidated into single SummarizeArticle RPC
- Client fallback chain preserved identically (ollama -> groq -> openrouter -> browser T5)
- Redis cache key strategy preserved (v3 prefix, same hash)
- 4 legacy files removed
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/03-legacy-edge-function-migration/03-02-SUMMARY.md`
</output>
