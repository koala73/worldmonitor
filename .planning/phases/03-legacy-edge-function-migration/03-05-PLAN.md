---
phase: 03-legacy-edge-function-migration
plan: 05
type: execute
wave: 2
depends_on:
  - 03-02
  - 03-04
files_modified:
  - proto/worldmonitor/infrastructure/v1/get_temporal_baseline.proto
  - proto/worldmonitor/infrastructure/v1/record_baseline_snapshot.proto
  - proto/worldmonitor/infrastructure/v1/service.proto
  - api/server/worldmonitor/infrastructure/v1/handler.ts
  - src/services/temporal-baseline.ts
  - src/services/signal-aggregator.ts
  - src/App.ts
  - api/temporal-baseline.js
  - api/_upstash-cache.js
  - api/rss-proxy.js
  - api/fwdstart.js
  - api/story.js
  - api/og-story.js
  - api/download.js
  - api/version.js
  - src/services/desktop-readiness.ts
  - src/generated/client/worldmonitor/infrastructure/v1/service_client.ts
  - src/generated/server/worldmonitor/infrastructure/v1/service_server.ts
  - docs/api/InfrastructureService.openapi.yaml
  - docs/api/InfrastructureService.openapi.json
autonomous: true
requirements:
  - CLEAN-02
  - DOMAIN-10

must_haves:
  truths:
    - "Temporal baseline GET (anomaly check) and POST (batch update) work via InfrastructureService RPCs instead of /api/temporal-baseline"
    - "Welford's online algorithm preserved identically"
    - "Redis mget for batch key reads works via inline REST helper"
    - "6 non-JSON edge functions tagged with comment header"
    - "_upstash-cache.js deleted (last importers removed by plans 02 and this plan)"
    - "desktop-readiness.ts updated to reflect current sebuf API routes"
  artifacts:
    - path: "proto/worldmonitor/infrastructure/v1/get_temporal_baseline.proto"
      provides: "GetTemporalBaselineRequest/Response proto messages"
      contains: "GetTemporalBaselineRequest"
    - path: "proto/worldmonitor/infrastructure/v1/record_baseline_snapshot.proto"
      provides: "RecordBaselineSnapshotRequest/Response proto messages"
      contains: "RecordBaselineSnapshotRequest"
    - path: "api/server/worldmonitor/infrastructure/v1/handler.ts"
      provides: "getTemporalBaseline + recordBaselineSnapshot RPC handlers"
      contains: "getTemporalBaseline"
    - path: "src/services/temporal-baseline.ts"
      provides: "Client rewired to InfrastructureServiceClient"
      contains: "InfrastructureServiceClient"
  key_links:
    - from: "src/services/temporal-baseline.ts"
      to: "api/server/worldmonitor/infrastructure/v1/handler.ts"
      via: "InfrastructureServiceClient.getTemporalBaseline() and .recordBaselineSnapshot()"
      pattern: "client\\.(getTemporalBaseline|recordBaselineSnapshot)"
    - from: "api/server/worldmonitor/infrastructure/v1/handler.ts"
      to: "Upstash Redis"
      via: "Inline getCachedJson/setCachedJson/mgetJson helpers"
      pattern: "getCachedJson|setCachedJson|mgetJson"
---

<objective>
Migrate temporal-baseline to infrastructure domain RPCs (step 8), tag non-JSON endpoints (step 9), and perform final cleanup (step 10).

Purpose: Complete the last RPC migration (temporal-baseline with Welford's algorithm and Redis mget), tag non-migratable edge functions, delete _upstash-cache.js (last importer removed), and finalize the phase.
Output: Working temporal baseline RPCs, tagged non-JSON files, all shared utility cleanup complete, desktop-readiness updated.
</objective>

<execution_context>
@/Users/sebastienmelki/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastienmelki/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-legacy-edge-function-migration/03-RESEARCH.md
@api/temporal-baseline.js
@api/_upstash-cache.js
@src/services/temporal-baseline.ts
@src/services/signal-aggregator.ts
@api/server/worldmonitor/infrastructure/v1/handler.ts
@proto/worldmonitor/infrastructure/v1/service.proto
@src/services/desktop-readiness.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add temporal baseline protos + implement handler with mget</name>
  <files>
    proto/worldmonitor/infrastructure/v1/get_temporal_baseline.proto
    proto/worldmonitor/infrastructure/v1/record_baseline_snapshot.proto
    proto/worldmonitor/infrastructure/v1/service.proto
    api/server/worldmonitor/infrastructure/v1/handler.ts
  </files>
  <action>
**Step 8: Temporal baseline migration** — 2 RPCs (GET anomaly check, POST batch update)

1. Create `proto/worldmonitor/infrastructure/v1/get_temporal_baseline.proto`:
   ```protobuf
   syntax = "proto3";
   package worldmonitor.infrastructure.v1;

   message GetTemporalBaselineRequest {
     string type = 1;     // "military_flights", "vessels", "protests", "news", "ais_gaps", "satellite_fires"
     string region = 2;   // default "global"
     double count = 3;    // current observed count
   }

   message BaselineAnomaly {
     double z_score = 1;
     string severity = 2;   // "critical", "high", "medium", "normal"
     double multiplier = 3;
   }

   message BaselineStats {
     double mean = 1;
     double std_dev = 2;
     int32 sample_count = 3;
   }

   message GetTemporalBaselineResponse {
     BaselineAnomaly anomaly = 1;  // null/absent if no anomaly
     BaselineStats baseline = 2;   // absent if learning
     bool learning = 3;
     int32 sample_count = 4;
     int32 samples_needed = 5;
     string error = 6;
   }
   ```

2. Create `proto/worldmonitor/infrastructure/v1/record_baseline_snapshot.proto`:
   ```protobuf
   syntax = "proto3";
   package worldmonitor.infrastructure.v1;

   message BaselineUpdate {
     string type = 1;
     string region = 2;  // default "global"
     double count = 3;
   }

   message RecordBaselineSnapshotRequest {
     repeated BaselineUpdate updates = 1;
   }

   message RecordBaselineSnapshotResponse {
     int32 updated = 1;
     string error = 2;
   }
   ```

3. Add 2 RPCs to `proto/worldmonitor/infrastructure/v1/service.proto`:
   - Import both new proto files
   - Add GET: `rpc GetTemporalBaseline(GetTemporalBaselineRequest) returns (GetTemporalBaselineResponse) { option (sebuf.http.config) = {path: "/get-temporal-baseline"}; }`
   - Add POST: `rpc RecordBaselineSnapshot(RecordBaselineSnapshotRequest) returns (RecordBaselineSnapshotResponse) { option (sebuf.http.config) = {path: "/record-baseline-snapshot"}; }`

4. Run `cd proto && buf generate`

5. Implement both handlers in `api/server/worldmonitor/infrastructure/v1/handler.ts`:

   a. **Inline Upstash Redis helpers** — Copy getCachedJson/setCachedJson from military handler pattern. Add an `mgetJson` helper for batch reads:
      ```typescript
      async function mgetJson(keys: string[]): Promise<(unknown | null)[]> {
        const url = process.env.UPSTASH_REDIS_REST_URL;
        const token = process.env.UPSTASH_REDIS_REST_TOKEN;
        if (!url || !token) return keys.map(() => null);
        try {
          const resp = await fetch(`${url}`, {
            method: 'POST',
            headers: {
              Authorization: `Bearer ${token}`,
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(['MGET', ...keys]),
            signal: AbortSignal.timeout(5_000),
          });
          if (!resp.ok) return keys.map(() => null);
          const data = (await resp.json()) as { result?: (string | null)[] };
          return (data.result || []).map(v => v ? JSON.parse(v) : null);
        } catch {
          return keys.map(() => null);
        }
      }
      ```

   b. **Constants** — port exactly:
      - BASELINE_TTL = 7776000 (90 days)
      - MIN_SAMPLES = 10
      - Z thresholds: LOW=1.5, MEDIUM=2.0, HIGH=3.0
      - VALID_TYPES: ['military_flights', 'vessels', 'protests', 'news', 'ais_gaps', 'satellite_fires']

   c. **Helper functions** — port exactly:
      - `makeKey(type, region, weekday, month)` → `baseline:${type}:${region}:${weekday}:${month}`
      - `getSeverity(zScore)` → critical/high/medium/normal thresholds

   d. **getTemporalBaseline handler** — port GET logic:
      - Validate type (must be in VALID_TYPES) and count (must be a number)
      - Region defaults to 'global'
      - Get current weekday (UTC) and month (UTC)
      - Build key, fetch from Redis via getCachedJson
      - If no baseline or sampleCount < MIN_SAMPLES: return learning=true
      - Compute variance, stdDev, zScore
      - If zScore >= Z_THRESHOLD_LOW: return anomaly with severity and multiplier
      - Return baseline stats

   e. **recordBaselineSnapshot handler** — port POST logic:
      - Validate updates array (max 20)
      - Get current weekday (UTC) and month (UTC)
      - Build keys for all updates
      - Batch read existing baselines via mgetJson
      - For each update, apply Welford's online algorithm:
        ```
        n = prev.sampleCount + 1
        delta = count - prev.mean
        newMean = prev.mean + delta / n
        delta2 = count - newMean
        newM2 = prev.m2 + delta * delta2
        ```
      - Write updated baselines via setCachedJson with 90-day TTL
      - Return count of successful writes

   **CRITICAL:** Welford's algorithm must be ported exactly. The variance formula `m2 / (n - 1)` uses Bessel's correction. Z-score uses absolute value.
  </action>
  <verify>
`cd proto && buf lint` passes. `npx tsc --noEmit` passes. Both proto files exist. Handler has both getTemporalBaseline and recordBaselineSnapshot methods. mgetJson helper present.
  </verify>
  <done>Temporal baseline protos defined. Handler implements Welford's algorithm, Redis mget for batch reads, anomaly detection with z-score thresholds.</done>
</task>

<task type="auto">
  <name>Task 2: Rewire temporal-baseline client + tag non-JSON files + final cleanup</name>
  <files>
    src/services/temporal-baseline.ts
    src/services/signal-aggregator.ts
    src/App.ts
    api/temporal-baseline.js
    api/_upstash-cache.js
    api/rss-proxy.js
    api/fwdstart.js
    api/story.js
    api/og-story.js
    api/download.js
    api/version.js
    src/services/desktop-readiness.ts
  </files>
  <action>
**Step 8 continued: Client rewire**

1. Read `src/services/temporal-baseline.ts` to understand current fetch patterns for `/api/temporal-baseline`

2. Rewire to use InfrastructureServiceClient:
   - Import `InfrastructureServiceClient` from `@/generated/client/worldmonitor/infrastructure/v1/service_client`
   - Create client: `new InfrastructureServiceClient('', { fetch: fetch.bind(globalThis) })`
   - Replace GET fetch `/api/temporal-baseline?type=...&region=...&count=...` with `client.getTemporalBaseline({ type, region, count })`
   - Replace POST fetch `/api/temporal-baseline` with `client.recordBaselineSnapshot({ updates: [...] })`
   - Map proto response fields to existing interface

3. Check `src/services/signal-aggregator.ts` and `src/App.ts` for temporal-baseline references and rewire if needed

4. Delete `api/temporal-baseline.js`

**Step 9: Tag non-JSON edge functions**

5. Add header comment to each non-migratable file (per locked decision):
   - `api/rss-proxy.js` — prepend `// Non-sebuf: returns XML/HTML, stays as standalone Vercel function\n` as first line (before any existing comments/imports)
   - `api/fwdstart.js` — same comment
   - `api/story.js` — same comment
   - `api/og-story.js` — same comment
   - `api/download.js` — same comment
   - `api/version.js` — same comment

**Step 10: Final cleanup**

6. Delete `api/_upstash-cache.js` — its two importers were:
   - `api/_summarize-handler.js` (deleted in plan 02)
   - `api/temporal-baseline.js` (deleted in this task above)
   Both are now gone, so it's safe to delete.

7. Update `src/services/desktop-readiness.ts`:
   - Review and update `apiRoutes` arrays for any features that still reference legacy `/api/...` paths
   - Ensure features that were migrated point to the sebuf handler paths or have been updated already
   - The wingbits changes in plan 01 already updated some references; verify no stale references remain for gdelt-doc, summarization, macro-signals, tech-events, temporal-baseline

8. Run `npx tsc --noEmit`

9. Commit: `feat(03-05): migrate temporal-baseline + tag non-JSON + final cleanup`
  </action>
  <verify>
`npx tsc --noEmit` passes. Deleted files: `api/temporal-baseline.js`, `api/_upstash-cache.js`. 6 non-JSON files have `// Non-sebuf:` comment. No references to legacy endpoint paths in `src/services/temporal-baseline.ts`. `grep -r '_upstash-cache' api/` returns nothing (no importers left).
  </verify>
  <done>Step 8 (temporal-baseline), step 9 (non-JSON tagging), and step 10 (final cleanup) all complete. _upstash-cache.js deleted. All migratable legacy edge functions now use sebuf RPCs. Phase 3 complete.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — full TypeScript compilation passes
2. Deleted: `api/temporal-baseline.js`, `api/_upstash-cache.js`
3. Tagged: 6 non-JSON files with `// Non-sebuf:` comment
4. `src/services/temporal-baseline.ts` uses `InfrastructureServiceClient`
5. `grep -r '_upstash-cache' api/` — no imports remain
6. `src/services/desktop-readiness.ts` has no stale legacy API route references
7. All remaining files in `api/` are either:
   - `[[...path]].js` (catch-all gateway) + `[[...path]].ts` (sebuf handler router)
   - `_cors.js` (kept per decision — needed by non-JSON files)
   - Non-JSON edge functions with `// Non-sebuf:` tags
   - `api/server/` (sebuf handler directory)
   - `api/data/` (data files)
</verification>

<success_criteria>
- Steps 8, 9, 10 complete
- Temporal baseline migrated with Welford's algorithm and Redis mget
- 6 non-JSON files tagged
- _upstash-cache.js deleted (no importers remain)
- desktop-readiness.ts updated
- TypeScript compiles cleanly
- Phase 3 is COMPLETE — all migratable legacy edge functions now use sebuf RPCs
</success_criteria>

<output>
After completion, create `.planning/phases/03-legacy-edge-function-migration/03-05-SUMMARY.md`
</output>
