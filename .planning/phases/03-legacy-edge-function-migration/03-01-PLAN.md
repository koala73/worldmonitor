---
phase: 03-legacy-edge-function-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - proto/worldmonitor/intelligence/v1/search_gdelt_documents.proto
  - proto/worldmonitor/intelligence/v1/service.proto
  - api/server/worldmonitor/intelligence/v1/handler.ts
  - src/services/gdelt-intel.ts
  - api/gdelt-doc.js
  - api/_ip-rate-limit.js
  - src/generated/client/worldmonitor/intelligence/v1/service_client.ts
  - src/generated/server/worldmonitor/intelligence/v1/service_server.ts
  - docs/api/IntelligenceService.openapi.yaml
  - docs/api/IntelligenceService.openapi.json
autonomous: true
requirements:
  - CLEAN-02
  - DOMAIN-10

must_haves:
  truths:
    - "Wingbits migration working tree changes are committed"
    - "GDELT document search works via IntelligenceService.SearchGdeltDocuments RPC instead of /api/gdelt-doc"
    - "Dead _ip-rate-limit.js is deleted"
    - "Proto messages for SearchGdeltDocuments match the existing JSON response shape from gdelt-doc.js"
  artifacts:
    - path: "proto/worldmonitor/intelligence/v1/search_gdelt_documents.proto"
      provides: "SearchGdeltDocumentsRequest/Response proto messages"
      contains: "SearchGdeltDocumentsRequest"
    - path: "api/server/worldmonitor/intelligence/v1/handler.ts"
      provides: "searchGdeltDocuments RPC handler method"
      contains: "searchGdeltDocuments"
    - path: "src/services/gdelt-intel.ts"
      provides: "Client rewired to IntelligenceServiceClient"
      contains: "IntelligenceServiceClient"
  key_links:
    - from: "src/services/gdelt-intel.ts"
      to: "api/server/worldmonitor/intelligence/v1/handler.ts"
      via: "IntelligenceServiceClient.searchGdeltDocuments()"
      pattern: "client\\.searchGdeltDocuments"
---

<objective>
Commit verified wingbits migration (step 3, already done in working tree), migrate GDELT document search to intelligence domain RPC (step 4), and delete dead _ip-rate-limit.js utility.

Purpose: Clear three quick items — verify step 3, implement one low-effort migration (step 4), and begin shared utility cleanup.
Output: Committed wingbits changes, working SearchGdeltDocuments RPC, deleted dead code.
</objective>

<execution_context>
@/Users/sebastienmelki/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastienmelki/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-legacy-edge-function-migration/03-RESEARCH.md
@api/gdelt-doc.js
@api/server/worldmonitor/intelligence/v1/handler.ts
@src/services/gdelt-intel.ts
@proto/worldmonitor/intelligence/v1/service.proto
</context>

<tasks>

<task type="auto">
  <name>Task 1: Commit wingbits migration + verify step 3</name>
  <files>
    api/server/worldmonitor/military/v1/handler.ts
    api/wingbits/[[...path]].js
    api/wingbits/details/[icao24].js
    api/wingbits/details/batch.js
    proto/worldmonitor/military/v1/service.proto
    proto/worldmonitor/military/v1/get_aircraft_details.proto
    proto/worldmonitor/military/v1/get_aircraft_details_batch.proto
    proto/worldmonitor/military/v1/get_wingbits_status.proto
    src/services/wingbits.ts
    src/services/desktop-readiness.ts
    docs/api/MilitaryService.openapi.yaml
    docs/api/MilitaryService.openapi.json
    src/generated/client/worldmonitor/military/v1/service_client.ts
    src/generated/server/worldmonitor/military/v1/service_server.ts
  </files>
  <action>
Step 3 (wingbits) was implemented in a prior session -- all changes exist in the working tree but are uncommitted. Verify and commit:

1. Run `npx tsc --noEmit` to confirm TypeScript compiles with the wingbits changes
2. Verify the 3 new proto files exist: `proto/worldmonitor/military/v1/get_aircraft_details.proto`, `get_aircraft_details_batch.proto`, `get_wingbits_status.proto`
3. Verify `src/services/wingbits.ts` uses `MilitaryServiceClient` (not fetch to /api/wingbits)
4. Verify `api/wingbits/` directory files are git-deleted
5. Stage all wingbits-related changes and commit: `feat(03-01): commit wingbits migration (step 3) — 3 RPCs added to military domain`
  </action>
  <verify>
`npx tsc --noEmit` passes. `git log --oneline -1` shows the wingbits commit. `git status` shows no wingbits-related changes.
  </verify>
  <done>All wingbits migration changes committed. Step 3 verified complete.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate GDELT doc search to intelligence domain + delete _ip-rate-limit.js</name>
  <files>
    proto/worldmonitor/intelligence/v1/search_gdelt_documents.proto
    proto/worldmonitor/intelligence/v1/service.proto
    api/server/worldmonitor/intelligence/v1/handler.ts
    src/services/gdelt-intel.ts
    api/gdelt-doc.js
    api/_ip-rate-limit.js
  </files>
  <action>
**Step 4: GDELT doc search migration** (68-line simple proxy, LOW effort)

1. Create `proto/worldmonitor/intelligence/v1/search_gdelt_documents.proto`:
   ```protobuf
   syntax = "proto3";
   package worldmonitor.intelligence.v1;
   import "sebuf/ts/options.proto";

   message SearchGdeltDocumentsRequest {
     string query = 1;
     int32 max_records = 2;
     string timespan = 3;
   }

   message GdeltArticle {
     string title = 1;
     string url = 2;
     string source = 3;
     string date = 4;
     string image = 5;
     string language = 6;
     double tone = 7;
   }

   message SearchGdeltDocumentsResponse {
     repeated GdeltArticle articles = 1;
     string query = 2;
     string error = 3;
   }
   ```

2. Add RPC to `proto/worldmonitor/intelligence/v1/service.proto`:
   - Import `search_gdelt_documents.proto`
   - Add: `rpc SearchGdeltDocuments(SearchGdeltDocumentsRequest) returns (SearchGdeltDocumentsResponse) { option (sebuf.http.config) = {path: "/search-gdelt-documents"}; }`

3. Run `cd proto && buf generate` to regenerate TypeScript

4. Implement `searchGdeltDocuments` handler method in `api/server/worldmonitor/intelligence/v1/handler.ts`:
   - Port logic from `api/gdelt-doc.js` exactly (no behavior changes)
   - Proxy to `https://api.gdeltproject.org/api/v2/doc/doc` with query params: query, mode=artlist, maxrecords (capped at 20, default 10), format=json, sort=date, timespan (default 72h)
   - Map response articles to GdeltArticle proto shape: title, url, source (domain or source.domain), date (seendate), image (socialimage), language, tone
   - On error, return error field in response (not HTTP error -- match legacy behavior returning 500 with error+articles)
   - Validate query is present and >= 2 chars, return error in response if not

5. Rewire `src/services/gdelt-intel.ts`:
   - Import `IntelligenceServiceClient` from generated client
   - Create client: `new IntelligenceServiceClient('', { fetch: fetch.bind(globalThis) })`
   - Replace fetch('/api/gdelt-doc?...') call with `client.searchGdeltDocuments({ query, maxRecords, timespan })`
   - Map response to existing interface used by consumers

6. Delete `api/gdelt-doc.js`

**Immediate cleanup:**
7. Delete `api/_ip-rate-limit.js` (confirmed zero importers in any code file)

8. Run `cd proto && buf generate` if not done, then `npx tsc --noEmit`

9. Commit: `feat(03-01): migrate gdelt-doc to intelligence RPC + delete _ip-rate-limit.js`
  </action>
  <verify>
`npx tsc --noEmit` passes. `api/gdelt-doc.js` is deleted. `api/_ip-rate-limit.js` is deleted. `grep -r 'gdelt-doc' src/` returns no fetch references to the legacy endpoint.
  </verify>
  <done>GDELT document search uses IntelligenceService.SearchGdeltDocuments RPC. Dead _ip-rate-limit.js deleted. Legacy api/gdelt-doc.js removed.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — full TypeScript compilation passes
2. `git log --oneline -3` — shows two new commits (wingbits + gdelt)
3. Deleted files: `api/wingbits/` (3 files), `api/gdelt-doc.js`, `api/_ip-rate-limit.js`
4. No remaining references to `/api/gdelt-doc` or `/api/wingbits` in `src/` directory
</verification>

<success_criteria>
- Steps 3 and 4 complete — wingbits committed, GDELT migrated
- _ip-rate-limit.js deleted (first shared utility cleanup)
- TypeScript compiles cleanly
- All changes committed to branch
</success_criteria>

<output>
After completion, create `.planning/phases/03-legacy-edge-function-migration/03-01-SUMMARY.md`
</output>
