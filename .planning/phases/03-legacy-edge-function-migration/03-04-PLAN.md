---
phase: 03-legacy-edge-function-migration
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - proto/worldmonitor/research/v1/list_tech_events.proto
  - proto/worldmonitor/research/v1/service.proto
  - api/server/worldmonitor/research/v1/handler.ts
  - api/data/city-coords.ts
  - src/components/TechEventsPanel.ts
  - src/App.ts
  - api/tech-events.js
  - src/generated/client/worldmonitor/research/v1/service_client.ts
  - src/generated/server/worldmonitor/research/v1/service_server.ts
  - docs/api/ResearchService.openapi.yaml
  - docs/api/ResearchService.openapi.json
autonomous: true
requirements:
  - CLEAN-02
  - DOMAIN-10

must_haves:
  truths:
    - "Tech events work via ResearchService.ListTechEvents RPC instead of /api/tech-events"
    - "ICS parsing (Techmeme) and RSS parsing (dev.events) preserved identically"
    - "500-city geocoding lookup preserved in separate data file"
    - "Curated events merged and deduplicated"
    - "Filters (type, mappable, days, limit) work identically"
    - "Proto messages match the existing JSON response shape"
  artifacts:
    - path: "proto/worldmonitor/research/v1/list_tech_events.proto"
      provides: "ListTechEventsRequest/Response proto messages with TechEvent"
      contains: "ListTechEventsRequest"
    - path: "api/server/worldmonitor/research/v1/handler.ts"
      provides: "listTechEvents RPC handler with ICS+RSS parsing"
      contains: "listTechEvents"
    - path: "api/data/city-coords.ts"
      provides: "500-city geocoding lookup table"
      contains: "CITY_COORDS"
    - path: "src/components/TechEventsPanel.ts"
      provides: "Consumer rewired to ResearchServiceClient"
      contains: "ResearchServiceClient"
  key_links:
    - from: "src/components/TechEventsPanel.ts"
      to: "api/server/worldmonitor/research/v1/handler.ts"
      via: "ResearchServiceClient.listTechEvents()"
      pattern: "client\\.listTechEvents|listTechEvents"
    - from: "api/server/worldmonitor/research/v1/handler.ts"
      to: "api/data/city-coords.ts"
      via: "import CITY_COORDS"
      pattern: "CITY_COORDS"
---

<objective>
Migrate the tech-events endpoint to the research domain as a ListTechEvents RPC (step 7).

Purpose: Consolidate the 737-line tech-events endpoint (ICS+RSS parsing, 500-city geocoding, curated events) into a typed sebuf RPC. The large CITY_COORDS table goes into a separate data file to keep the handler manageable.
Output: Working ListTechEvents RPC, city-coords data file, legacy tech-events.js deleted.
</objective>

<execution_context>
@/Users/sebastienmelki/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastienmelki/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-legacy-edge-function-migration/03-RESEARCH.md
@api/tech-events.js
@src/components/TechEventsPanel.ts
@src/App.ts
@api/server/worldmonitor/research/v1/handler.ts
@proto/worldmonitor/research/v1/service.proto
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ListTechEvents proto + city-coords data + implement handler</name>
  <files>
    proto/worldmonitor/research/v1/list_tech_events.proto
    proto/worldmonitor/research/v1/service.proto
    api/data/city-coords.ts
    api/server/worldmonitor/research/v1/handler.ts
  </files>
  <action>
1. Create `proto/worldmonitor/research/v1/list_tech_events.proto`:
   ```protobuf
   syntax = "proto3";
   package worldmonitor.research.v1;

   message ListTechEventsRequest {
     string type = 1;       // "all", "conferences", "earnings", "ipo", "other" — empty = all
     bool mappable = 2;     // only events with non-virtual coords
     int32 limit = 3;       // max events (0 = unlimited)
     int32 days = 4;        // events within N days (0 = unlimited)
   }

   message TechEventCoords {
     double lat = 1;
     double lng = 2;
     string country = 3;
     string original = 4;
     bool virtual = 5;
   }

   message TechEvent {
     string id = 1;
     string title = 2;
     string type = 3;        // "conference", "earnings", "ipo", "other"
     string location = 4;
     TechEventCoords coords = 5;
     string start_date = 6;  // YYYY-MM-DD
     string end_date = 7;    // YYYY-MM-DD
     string url = 8;
     string source = 9;      // "techmeme", "dev.events", "curated"
     string description = 10;
   }

   message ListTechEventsResponse {
     bool success = 1;
     int32 count = 2;
     int32 conference_count = 3;
     int32 mappable_count = 4;
     string last_updated = 5;  // ISO 8601
     repeated TechEvent events = 6;
     string error = 7;
   }
   ```

2. Add RPC to `proto/worldmonitor/research/v1/service.proto`:
   - Import `list_tech_events.proto`
   - Add: `rpc ListTechEvents(ListTechEventsRequest) returns (ListTechEventsResponse) { option (sebuf.http.config) = {path: "/list-tech-events"}; }`

3. Run `cd proto && buf generate`

4. Create `api/data/city-coords.ts` — Extract the CITY_COORDS lookup table from `api/tech-events.js` into a typed TypeScript file:
   ```typescript
   export interface CityCoord {
     lat: number;
     lng: number;
     country: string;
     virtual?: boolean;
   }

   export const CITY_COORDS: Record<string, CityCoord> = {
     // Exact same 500+ entries from api/tech-events.js
     'san francisco': { lat: 37.7749, lng: -122.4194, country: 'USA' },
     // ... all entries ...
     'hybrid': { lat: 0, lng: 0, country: 'Virtual', virtual: true },
   };
   ```
   Copy ALL entries exactly from `api/tech-events.js`. No additions, no removals, no coordinate changes.

5. Create CURATED_EVENTS as a typed array constant inside the handler (or in the data file if cleaner). These are the 5 curated events from the legacy file. Copy exactly.

6. Implement `listTechEvents` handler in `api/server/worldmonitor/research/v1/handler.ts`:

   Port ALL logic from `api/tech-events.js`:

   a. **Import** CITY_COORDS from `api/data/city-coords.ts`:
      `import { CITY_COORDS, type CityCoord } from '../../../../data/city-coords';`
      (Adjust relative path to match handler location — similar to how military handler imports from `api/data/military-hex-db.js`)

   b. **normalizeLocation(location)** — port exactly: direct lookup, strip state/country suffix, fuzzy contains match

   c. **parseICS(icsText)** — port exactly: split on BEGIN:VEVENT, extract SUMMARY/LOCATION/DTSTART/DTEND/URL/UID, determine type (earnings/ipo/conference/other), geocode via normalizeLocation, format dates as YYYY-MM-DD

   d. **parseDevEventsRSS(rssText)** — port exactly: regex-based RSS parsing (<item>), extract title/link/description/guid, parse date from description, parse location, skip past events, geocode

   e. **CURATED_EVENTS** — 5 hardcoded events (STEP Dubai 2026, GITEX Global, TOKEN2049 Dubai, Collision, Web Summit). Define as typed constant.

   f. **Main handler logic** — port exactly:
      - Parallel fetch of Techmeme ICS + dev.events RSS via Promise.allSettled
      - Parse both, merge events
      - Add curated events (only future ones)
      - Deduplicate by title similarity (first 30 chars, alphanumeric only)
      - Sort by start date
      - Filter by type, mappable (coords present and not virtual), days, limit
      - Compute metadata: conferenceCount, mappableCount
      - Return success response with events array

   g. **Error handling** — on catch: return `{ success: false, error: message }`

   **CRITICAL:** The ICS parser regex patterns, the RSS parser regex patterns, and the date parsing logic must be ported exactly. No improvements to parsing.
  </action>
  <verify>
`cd proto && buf lint` passes. `npx tsc --noEmit` passes. `api/data/city-coords.ts` exists with 500+ entries. Handler has listTechEvents with ICS+RSS parsing. Proto has TechEvent and coords messages.
  </verify>
  <done>ListTechEvents proto defined. City-coords data file extracted. Handler implements ICS+RSS parsing, geocoding, curated event merging, deduplication, and filtering.</done>
</task>

<task type="auto">
  <name>Task 2: Rewire TechEventsPanel + App consumers + delete legacy file</name>
  <files>
    src/components/TechEventsPanel.ts
    src/App.ts
    api/tech-events.js
  </files>
  <action>
1. Read `src/components/TechEventsPanel.ts` and `src/App.ts` to understand current fetch patterns for `/api/tech-events`

2. Rewire `src/components/TechEventsPanel.ts`:
   - Import `ResearchServiceClient` from `@/generated/client/worldmonitor/research/v1/service_client`
   - Create client: `new ResearchServiceClient('', { fetch: fetch.bind(globalThis) })`
   - Replace `fetch('/api/tech-events?days=180&limit=100')` (or similar) with `client.listTechEvents({ days: 180, limit: 100 })`
   - Map proto response fields to existing interface:
     - Proto snake_case -> generated camelCase (verify auto-conversion)
     - `success`, `count`, `conferenceCount`, `mappableCount`, `lastUpdated`, `events`
     - Each event: `id`, `title`, `type`, `location`, `coords` (with lat/lng/country/original/virtual), `startDate`, `endDate`, `url`, `source`, `description`

3. Rewire `src/App.ts`:
   - Find the fetch to `/api/tech-events` and replace with client call
   - Same ResearchServiceClient import pattern
   - Map response fields identically

4. Delete `api/tech-events.js`

5. Run `npx tsc --noEmit`

6. Commit: `feat(03-04): migrate tech-events to research ListTechEvents RPC`
  </action>
  <verify>
`npx tsc --noEmit` passes. `api/tech-events.js` deleted. `grep -r 'tech-events' src/` shows no fetch to legacy endpoint. Both TechEventsPanel and App use ResearchServiceClient.
  </verify>
  <done>TechEventsPanel and App use ResearchService.ListTechEvents RPC. Legacy api/tech-events.js deleted.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — full TypeScript compilation passes
2. `api/tech-events.js` deleted
3. `api/data/city-coords.ts` exists with 500+ city entries
4. `src/components/TechEventsPanel.ts` and `src/App.ts` use `ResearchServiceClient.listTechEvents()`
5. Proto has full TechEvent structure with coords sub-message
6. Handler parses both Techmeme ICS and dev.events RSS, merges curated events
</verification>

<success_criteria>
- Step 7 complete — tech-events consolidated into ListTechEvents RPC
- ICS and RSS parsing preserved identically
- 500-city geocoding table extracted to separate data file
- Curated events preserved
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/03-legacy-edge-function-migration/03-04-SUMMARY.md`
</output>
