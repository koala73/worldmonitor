---
phase: 3-sebuf-legacy-migration
task: 3
total_tasks: 10
status: in_progress
last_updated: 2026-02-20T16:30:00Z
---

<current_state>
Sebuf migration of remaining legacy `api/*.js` edge functions. Phases 1-2 of 10 complete and committed on `feat/sebuf-integration`. Phase 3 (wingbits) is next.

**Full detailed plan**: `memory/sebuf-migration-plan.md` — contains exact proto definitions, handler patterns, client rewire targets, and file deletions for every remaining phase.
</current_state>

<completed_work>

- Phase 1: Dead code cleanup - Done (deleted coingecko.js, debug-env.js, cache-telemetry.js, _cache-telemetry.js, removed API_URLS config, updated desktop-readiness)
- Phase 2: stock-index + opensky migration - Done (created GetCountryStockIndex RPC in market domain, filled ListMilitaryFlights stub in military handler, rewired App.ts, deleted 2 legacy files)
- Merged main into branch (resolved vite.config.ts conflict with polymarketPlugin + earthquake proxy)
</completed_work>

<remaining_work>

- Phase 3: Wingbits proxy → military domain (3 new RPCs, delete api/wingbits/ dir)
- Phase 4: GDELT doc search → intelligence domain (1 RPC, delete api/gdelt-doc.js)
- Phase 5: Summarization consolidation → news domain (1 RPC, delete 4 files)
- Phase 6: Macro-signals → economic domain (1 RPC, delete api/macro-signals.js) — HIGH effort
- Phase 7: Tech-events → research domain (1 RPC, delete api/tech-events.js) — HIGH effort
- Phase 8: Temporal-baseline → infrastructure domain (2 RPCs, delete api/temporal-baseline.js)
- Phase 9: Non-JSON endpoint reorg (comment tags, no moves needed)
- Phase 10: Final cleanup (delete shared utils, update desktop-readiness, sync main)
</remaining_work>

<decisions_made>

- Proto codegen: `cd proto && buf generate` (buf + protoc-gen-ts-client + protoc-gen-ts-server all in PATH)
- Client construction: always `new XServiceClient('', { fetch: fetch.bind(globalThis) })`
- Handler pattern: `declare const process` at top, inline Upstash Redis helpers, in-memory caching
- OpenSky: kept client-side military-flights.ts logic unchanged (too complex to refactor); just deleted the edge function proxy. Vite dev proxy + Railway relay handle the transport.
- Non-JSON endpoints (Phase 9): cannot move into api/server/ — Vercel file-based routing requires them in api/ root. Use comment tags instead.
- StockIndexData type expects string price/weekChangePercent — App.ts adapts RPC number response with String() conversion
</decisions_made>

<blockers>
- None currently
</blockers>

<context>
The migration follows a consistent pattern per phase:
1. Create proto file(s) in proto/worldmonitor/{domain}/v1/
2. Add RPC(s) to service.proto
3. Run `cd proto && buf generate`
4. Implement handler method(s) in api/server/worldmonitor/{domain}/v1/handler.ts
5. Rewire client code to use generated {Domain}ServiceClient
6. Delete legacy api/*.js file(s)
7. Verify with `npx tsc --noEmit`
8. Commit

vite.config.ts sebufApiPlugin() and api/[[...path]].js already register ALL 17 domain handlers — no need to add new domain registrations, just new RPC methods to existing handlers.

Merge from main every 2-3 phases to avoid drift.
</context>

<next_action>
Start with Phase 3: Read `memory/sebuf-migration-plan.md` for full details. Read `api/wingbits/[[...path]].js` and `src/services/wingbits.ts` to understand the proxy. Create 3 proto files (get_aircraft_details, list_wingbits_flights, get_wingbits_status), add to military service.proto, generate, implement in military handler, rewire wingbits.ts client, delete api/wingbits/ directory.
</next_action>
