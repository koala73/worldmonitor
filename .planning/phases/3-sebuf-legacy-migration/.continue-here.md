---
phase: 3-sebuf-legacy-migration
task: 3
total_tasks: 10
status: in_progress
last_updated: 2026-02-20T18:00:00Z
---

<current_state>
Phase 3: Migrating remaining legacy `api/*.js` edge functions into sebuf RPCs. ALL 17 domain handlers + client wirings are already complete. This phase is purely about eliminating the remaining legacy edge function proxies.

Branch: `feat/sebuf-integration` (148 commits ahead of main, 0 behind)
</current_state>

<completed_work>

- Phase 1: Dead code cleanup — Done
- Phase 2: stock-index + opensky migration — Done
- ALL 17 domain handler implementations — Done (phases 2C-2L + commits 12-17/17)
- ALL 17 domain client wirings — Done
- Additional migrations (etf-flows, stablecoin, worldpop, theater-posture, intelligence, country-intel) — Done
- Dead legacy file cleanup — Done
- Merged main into branch multiple times (last merge: 924ce09, branch is 0 behind main)
</completed_work>

<remaining_work>

**Migratable to sebuf RPCs:**
- Step 3: `api/wingbits/` (3 files) → military domain (3 RPCs: GetAircraftDetails, GetAircraftDetailsBatch, GetWingbitsStatus)
  - Client: src/services/wingbits.ts calls /api/wingbits/health, /details/:icao24, /details/batch
  - Also: src/services/desktop-readiness.ts references apiRoutes: ['/api/wingbits']
- Step 4: `api/gdelt-doc.js` → intelligence domain (1 RPC: SearchGdeltDocuments)
  - Client: src/services/gdelt-intel.ts
- Step 5: `api/*-summarize.js` + `_summarize-handler.js` (4 files) → news domain (1 RPC)
  - Client: src/services/summarization.ts
- Step 6: `api/macro-signals.js` → economic domain (1 RPC) — HIGH effort
  - Client: src/components/MacroSignalsPanel.ts
- Step 7: `api/tech-events.js` → research domain (1 RPC) — HIGH effort
  - Client: src/components/TechEventsPanel.ts
- Step 8: `api/temporal-baseline.js` → infrastructure domain (2 RPCs)
  - Client: src/services/temporal-baseline.ts

**Non-migratable (step 9, tag only):**
- api/rss-proxy.js, api/fwdstart.js (RSS XML output)
- api/story.js, api/og-story.js (HTML output)
- api/download.js (redirect)
- api/version.js (simple JSON, keep as-is)

**Final cleanup (step 10):**
- Delete api/_cors.js, api/_upstash-cache.js, api/_ip-rate-limit.js
- Update desktop-readiness.ts
- Sync main
</remaining_work>

<decisions_made>

- Proto codegen: `cd proto && buf generate`
- Client construction: always `new XServiceClient('', { fetch: fetch.bind(globalThis) })`
- Handler pattern: `declare const process` at top, inline Upstash Redis helpers
- Non-JSON endpoints (step 9): cannot move into api/server/ — Vercel file-based routing requires them in api/ root
- The /api/wingbits/flights and /api/wingbits/flights/batch endpoints are NOT called by client code; they were only used by the old theater-posture.js which is already migrated. The military handler already calls Wingbits API directly for posture calculation. No need for flight RPCs.
</decisions_made>

<blockers>
- None currently
</blockers>

<context>
Each migration step follows the same pattern:
1. Add proto message file(s) in proto/worldmonitor/{domain}/v1/
2. Add RPC(s) to service.proto
3. Run `cd proto && buf generate`
4. Implement handler method(s) in api/server/worldmonitor/{domain}/v1/handler.ts
5. Rewire client code to use generated {Domain}ServiceClient (or add RPC call)
6. Delete legacy api/*.js file(s)
7. Verify with `npx tsc --noEmit`
8. Commit

All 17 domain handlers already exist — just need to add new RPC methods to existing handlers.
</context>

<next_action>
Start step 3 (wingbits migration):
1. Create 3 proto message files: get_aircraft_details.proto, get_aircraft_details_batch.proto, get_wingbits_status.proto
2. Add 3 RPCs to military service.proto
3. Run `cd proto && buf generate`
4. Add 3 handler methods to api/server/worldmonitor/military/v1/handler.ts
5. Rewire src/services/wingbits.ts to use MilitaryServiceClient instead of /api/wingbits
6. Update src/services/desktop-readiness.ts
7. Delete api/wingbits/ directory
8. Verify with `npx tsc --noEmit`
</next_action>
